<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GROVE | User Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --emerald: #10b981; --grove-deep: #061a14; --gold: #fbbf24; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; min-height: 100vh; margin: 0; color: #1e293b; overflow-x: hidden; }
        
        /* THE WITHERED STATE (SUSPENSION) */
        body.withered { filter: grayscale(1) brightness(0.6); pointer-events: none; }
        #suspension-overlay { 
            display: none; position: fixed; inset: 0; z-index: 9999; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            align-items: center; justify-content: center; pointer-events: auto;
        }

        /* ANIMATIONS: SEEDS & SOUL */
        .seed-header { position: relative; background: white; border-radius: 0 0 2.5rem 2.5rem; padding: 2rem 1.5rem; border-bottom: 1px solid #f1f5f9; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .seed { position: absolute; background: var(--emerald); border-radius: 50%; opacity: 0; animation: scatter 4s infinite ease-out; }
        @keyframes scatter { 0% { transform: translateY(0) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }

        /* THE GARDENER (ORCHARD EMPTY STATE) */
        .gardener-zone { display: flex; flex-direction: column; align-items: center; padding: 4rem 0; }
        .gardener-emoji { font-size: 50px; animation: walk 6s infinite ease-in-out; }
        @keyframes walk { 0%, 100% { transform: translateX(-20px) scaleX(1); } 50% { transform: translateX(20px) scaleX(-1); } }

        /* TABS & NAVIGATION */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--grove-deep); border-radius: 2rem; display: flex; justify-content: space-around; padding: 15px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); z-index: 100; }
        .nav-item { color: rgba(255,255,255,0.4); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--emerald); }

        /* WITHDRAWAL MODAL */
        #withdrawModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; padding: 2rem; }
    </style>
</head>
<body class="max-w-md mx-auto">

    <div id="suspension-overlay">
        <div class="text-center p-8">
            <h2 class="text-rose-500 font-black tracking-widest uppercase mb-2">Node Withered</h2>
            <p class="text-white/60 text-[10px] uppercase mb-8">Activation Seed Required: <span id="req-amt" class="text-emerald-400 font-black">GH‚Çµ0</span></p>
            <div class="bg-white/5 border border-white/10 p-6 rounded-3xl mb-8">
                <p class="text-white font-black text-2xl tracking-tighter">05XXXXXXXX</p>
                <p class="text-[8px] text-emerald-500 font-bold mt-2 uppercase">Momo Admin Reference: [Email]</p>
            </div>
            <button onclick="location.reload()" class="text-white font-black text-[9px] uppercase tracking-widest">Check Status</button>
        </div>
    </div>

    <header class="seed-header">
        <div id="particles" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
        <div class="relative z-10 flex justify-between items-start mb-8">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter text-slate-900">GROVE</h1>
                <p class="text-[8px] font-black text-emerald-500 uppercase tracking-widest italic">"Givers Never Lack"</p>
            </div>
            <button onclick="toggleGifterSignup()" class="bg-amber-400 text-black px-4 py-2 rounded-full font-black text-[8px] uppercase">Become a Gifter</button>
        </div>
        
        <div class="relative z-10 grid grid-cols-2 gap-4">
            <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100">
                <p class="text-[7px] font-black text-slate-400 uppercase mb-1">Seed Value</p>
                <p id="stat-seed" class="text-lg font-black text-slate-900 italic">‚Çµ0.00</p>
            </div>
            <div class="bg-emerald-50 p-5 rounded-3xl border border-emerald-100">
                <p class="text-[7px] font-black text-emerald-600 uppercase mb-1">Unclaimed Grace</p>
                <p id="stat-grace" class="text-lg font-black text-emerald-600 italic">‚Çµ0.00</p>
            </div>
        </div>
    </header>

    <main class="p-6 pb-32">
        <section id="orchard" class="tab-content active">
            <div id="gift-feed" class="space-y-4">
                </div>
            <div id="orchard-empty" class="gardener-zone hidden">
                <div class="gardener-emoji">üßë‚Äçüåæ</div>
                <p class="text-[9px] font-black text-slate-300 uppercase mt-4 italic">The Gardener is sowing new grace...</p>
            </div>
        </section>

        <section id="vault" class="tab-content">
            <div class="bg-slate-900 p-10 rounded-[3rem] text-center border border-white/5 relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-[8px] font-black text-emerald-400 uppercase mb-2 tracking-widest">Claim Vaulted</p>
                    <h2 id="stat-vault" class="text-5xl font-black text-white italic mb-10 tracking-tighter">‚Çµ0.00</h2>
                    <div class="space-y-3">
                        <button onclick="vaultGrace()" class="w-full py-4 bg-emerald-500 text-slate-950 font-black rounded-2xl text-[10px] uppercase">Vault All Grace</button>
                        <button onclick="openWithdraw()" class="w-full py-4 bg-white/5 text-white font-black rounded-2xl text-[10px] uppercase border border-white/10">Withdraw to Momo</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="ledger" class="tab-content">
            <h3 class="text-[9px] font-black text-slate-400 uppercase mb-4 tracking-widest">Transaction History</h3>
            <div id="ledger-list" class="bg-white rounded-3xl border border-slate-100 divide-y divide-slate-50 overflow-hidden">
                </div>
        </section>
    </main>

    <div id="withdrawModal">
        <div class="bg-white p-8 rounded-[3rem] w-full max-w-sm">
            <p class="text-center text-[10px] font-black text-emerald-600 uppercase mb-6 tracking-widest">Momo Authorization</p>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-[8px] font-black text-slate-400 uppercase ml-2">Available for Withdrawal</label>
                    <div id="wd-avail" class="text-xl font-black text-slate-900 p-4 bg-slate-50 rounded-2xl mt-1">‚Çµ0.00</div>
                </div>
                <input type="number" id="wd-amount" placeholder="Amount to Withdraw" class="w-full p-4 bg-slate-50 rounded-2xl font-black outline-none border border-slate-100" oninput="calculateFee()">
            </div>
            <div class="p-4 bg-rose-50 rounded-2xl mb-8">
                <div class="flex justify-between text-[8px] font-black uppercase text-rose-500">
                    <span>2% Service Charge</span>
                    <span id="wd-fee">‚Çµ0.00</span>
                </div>
                <div class="flex justify-between text-[10px] font-black uppercase text-slate-900 mt-2">
                    <span>Net Payout</span>
                    <span id="wd-net">‚Çµ0.00</span>
                </div>
            </div>
            <button onclick="submitWithdraw()" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl text-[10px] uppercase mb-4">Confirm Payout</button>
            <button onclick="closeModals()" class="w-full text-[8px] font-black text-slate-400 uppercase">Cancel</button>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('orchard', this)">Orchard</div>
        <div class="nav-item" onclick="switchTab('vault', this)">Vault</div>
        <div class="nav-item" onclick="switchTab('ledger', this)">Ledger</div>
    </nav>

    <script>
        const _gv = supabase.createClient(window.CONFIG.SB_URL, window.CONFIG.SB_KEY);
        let user = null, grace = 0, vaulted = 0;

        async function init() {
            const { data } = await _gv.auth.getUser();
            if (!data.user) return window.location.href = 'index.html';
            user = data.user;
            createSeeds(); sync();
            _gv.channel('db').on('postgres_changes', {event:'*', schema:'public'}, sync).subscribe();
        }

        async function sync() {
            // Profile & Suspension
            const { data: profile } = await _gv.from('profiles').select('*').eq('id', user.id).single();
            if (profile?.is_suspended) {
                document.body.classList.add('withered');
                document.getElementById('suspension-overlay').style.display = 'flex';
                document.getElementById('req-amt').innerText = `GH‚Çµ${profile.pledged_seed}`;
            }

            // Accounting Logic (No Pruning)
            const { data: ledger } = await _gv.from('ledger').select('*').eq('user_id', user.id).order('created_at', {ascending: false});
            const { data: allGifts } = await _gv.from('ledger').select('*').eq('entry_type', 'gift_sent');

            let totalGrace = 0, totalVaulted = 0, totalSeed = 0, consumedGrace = 0;
            const claimedIds = ledger.filter(l => l.entry_type === 'gift_received').map(l => l.description.replace('Claim: ', ''));

            ledger.forEach(l => {
                if (l.entry_type === 'seed' && !l.description.includes('Vault')) totalSeed += l.amount;
                if (l.entry_type === 'gift_received') totalGrace += l.amount;
                if (l.description.includes('Vault Transfer')) consumedGrace += l.amount;
                if (l.description.includes('Vault Transfer')) totalVaulted += l.amount;
                if (l.entry_type === 'withdrawal') totalVaulted += l.amount; // amount is negative
            });

            grace = totalGrace - consumedGrace;
            vaulted = totalVaulted;

            document.getElementById('stat-seed').innerText = `‚Çµ${totalSeed.toFixed(2)}`;
            document.getElementById('stat-grace').innerText = `‚Çµ${grace.toFixed(2)}`;
            document.getElementById('stat-vault').innerText = `‚Çµ${vaulted.toFixed(2)}`;
            document.getElementById('wd-avail').innerText = `‚Çµ${vaulted.toFixed(2)}`;

            // Feed Logic
            const avail = allGifts.filter(g => !claimedIds.includes(g.id.toString()));
            const feed = document.getElementById('gift-feed');
            if (avail.length === 0) {
                feed.innerHTML = ''; document.getElementById('orchard-empty').classList.remove('hidden');
            } else {
                document.getElementById('orchard-empty').classList.add('hidden');
                feed.innerHTML = avail.map(g => `
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 flex justify-between items-center">
                        <div><p class="text-[8px] font-black text-slate-400 uppercase">Available Grace</p>
                        <p class="text-xl font-black text-emerald-500 italic">‚Çµ${g.amount.toFixed(2)}</p></div>
                        <button onclick="claimGrace('${g.id}', ${g.amount})" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-[9px] uppercase">Capture</button>
                    </div>
                `).join('');
            }

            // Ledger Logic
            document.getElementById('ledger-list').innerHTML = ledger.map(l => `
                <div class="p-4 flex justify-between items-center">
                    <span class="text-[9px] font-bold text-slate-500 uppercase">${l.description || l.entry_type}</span>
                    <span class="text-xs font-black ${l.amount < 0 ? 'text-rose-500' : 'text-emerald-500'}">${l.amount < 0 ? '-' : '+'}‚Çµ${Math.abs(l.amount).toFixed(2)}</span>
                </div>
            `).join('');
        }

        function calculateFee() {
            const val = parseFloat(document.getElementById('wd-amount').value) || 0;
            const fee = val * 0.02;
            document.getElementById('wd-fee').innerText = `‚Çµ${fee.toFixed(2)}`;
            document.getElementById('wd-net').innerText = `‚Çµ${(val - fee).toFixed(2)}`;
        }

        async function submitWithdraw() {
            const val = parseFloat(document.getElementById('wd-amount').value);
            if (val > vaulted || val <= 0) return alert("Invalid Amount");
            await _gv.from('ledger').insert([{ user_id: user.id, amount: -val, entry_type: 'withdrawal', description: 'PENDING: Momo Payout' }]);
            closeModals(); sync();
        }

        async function claimGrace(id, amt) {
            await _gv.from('ledger').insert([{ user_id: user.id, amount: amt, entry_type: 'gift_received', description: `Claim: ${id}` }]);
            sync();
        }

        async function vaultGrace() {
            if (grace <= 0) return;
            await _gv.from('ledger').insert([{ user_id: user.id, amount: grace, entry_type: 'seed', description: 'Vault Transfer' }]);
            sync();
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            el.classList.add('active');
        }

        function createSeeds() {
            const box = document.getElementById('particles');
            for(let i=0; i<15; i++){
                const s = document.createElement('div'); s.className = 'seed';
                s.style.left = Math.random()*100+'%'; s.style.width = s.style.height = (Math.random()*4+2)+'px';
                s.style.animationDelay = Math.random()*4+'s'; box.appendChild(s);
            }
        }

        function openWithdraw() { document.getElementById('withdrawModal').style.display = 'flex'; }
        function closeModals() { document.getElementById('withdrawModal').style.display = 'none'; }
        init();
    </script>
</body>
</html>
