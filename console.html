<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GROVE | Master Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; min-height: 100vh; margin: 0; overflow-x: hidden; }
        .auth-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 1.5rem; }
        .nav-link { display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; transition: 0.3s; cursor: pointer; position: relative; }
        .nav-link.active { opacity: 1; color: #10b981; }
        .nav-badge { position: absolute; top: -5px; right: -5px; background: #f43f5e; color: white; font-size: 8px; font-weight: 900; padding: 2px 5px; border-radius: 6px; border: 2px solid #020617; }
        
        .tab-content { display: none; padding-bottom: 120px; }
        .tab-content.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .input-box { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: white; border-radius: 1rem; padding: 1rem; width: 100%; outline: none; font-size: 14px; transition: 0.3s; }
        .input-box:focus { border-color: #10b981; background: rgba(16, 185, 129, 0.05); }

        /* Impact Billboard Carousel */
        .billboard-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 10px 0; }
        .billboard-card { min-width: 88%; scroll-snap-align: center; border-radius: 2rem; overflow: hidden; position: relative; height: 240px; border: 1px solid rgba(255,255,255,0.1); background: #0f172a; }
        .billboard-img { width: 100%; height: 100%; object-cover: cover; opacity: 0.5; }
        .billboard-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, rgba(2,6,23,1) 15%, rgba(2,6,23,0) 100%); display: flex; flex-direction: column; justify-content: flex-end; padding: 25px; }

        /* Chat Bubbles */
        .chat-bubble { padding: 12px 16px; border-radius: 1.2rem; font-size: 11px; max-width: 85%; position: relative; line-height: 1.4; margin-bottom: 10px; }
        .bubble-in { background: rgba(255,255,255,0.08); color: #f1f5f9; align-self: flex-start; border-bottom-left-radius: 2px; }
        .bubble-out { background: #10b981; color: #020617; font-weight: 800; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .status-pill { font-size: 7px; font-weight: 900; padding: 2px 8px; border-radius: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-action { padding: 10px; border-radius: 12px; font-size: 8px; font-weight: 900; text-transform: uppercase; transition: 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn-verify { background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: rgba(16, 185, 129, 0.2); }
        .btn-msg { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border-color: rgba(59, 130, 246, 0.2); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .view-hidden { display: none !important; }

        /* Detailed Ledger Table */
        .ledger-row { display: grid; grid-template-columns: 1.5fr 2fr 1fr; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
    </style>
</head>
<body class="bg-slate-950">

    <header class="p-6 sticky top-0 z-40 bg-slate-950/90 backdrop-blur-xl border-b border-white/5">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter text-emerald-500">.terminal</h1>
                <p class="text-[8px] font-black text-amber-500 tracking-[0.3em] uppercase">Givers Never Lack</p>
            </div>
            <div class="text-right">
                <p id="stat-pool" class="text-xl font-black text-emerald-400 italic">‚Çµ0.00</p>
                <p class="text-[7px] font-black text-slate-500 uppercase tracking-widest">Grove Pool</p>
            </div>
        </div>

        <div class="flex gap-3 overflow-x-auto no-scrollbar">
            <div class="auth-card p-4 min-w-[120px] border-emerald-500/20">
                <p class="text-[7px] font-black text-emerald-500 uppercase mb-1">Vaulted</p>
                <p id="stat-vaulted" class="text-sm font-black italic">‚Çµ0.00</p>
            </div>
            <div class="auth-card p-4 min-w-[120px]">
                <p class="text-[7px] font-black text-blue-400 uppercase mb-1">Total Seed</p>
                <p id="stat-seeded" class="text-sm font-black italic">‚Çµ0.00</p>
            </div>
            <div class="auth-card p-4 min-w-[120px]">
                <p class="text-[7px] font-black text-slate-500 uppercase mb-1">Live Nodes</p>
                <p id="stat-nodes" class="text-sm font-black italic">0</p>
            </div>
        </div>
    </header>

    <main class="p-4">
        
        <section id="nodes" class="tab-content active">
            <div class="auth-card p-6 mb-6 border-blue-500/10">
                <h3 class="text-xs font-black uppercase text-blue-400 mb-4 italic">Authorize New Node</h3>
                <div class="space-y-3">
                    <input type="email" id="targetEmail" placeholder="Node Email Address" class="input-box">
                    <div class="flex gap-2">
                        <input type="number" id="minRange" placeholder="Min ‚Çµ" class="input-box">
                        <input type="number" id="maxRange" placeholder="Max ‚Çµ" class="input-box">
                    </div>
                    <button onclick="updateNodeStatus()" class="w-full py-4 bg-emerald-600 text-white font-black rounded-2xl text-[10px] uppercase italic tracking-widest">Verify & Lift Storm Lock</button>
                </div>
            </div>
            <input type="text" id="nodeSearch" oninput="renderNodes()" placeholder="Search Name/Email..." class="input-box mb-4 border-emerald-500/20">
            <div id="nodeList" class="space-y-3"></div>
        </section>

        <section id="missions" class="tab-content">
            <h3 class="text-[10px] font-black text-amber-500 uppercase mb-4 tracking-widest px-2 italic">Live Hub Preview</h3>
            <div id="billboardContent" class="billboard-container no-scrollbar mb-8"></div>

            <div class="auth-card p-6">
                <h3 class="text-sm font-black uppercase text-white mb-4 italic">Broadcast Mission</h3>
                <div class="space-y-3">
                    <input type="text" id="missionTitle" placeholder="Mission Name" class="input-box">
                    <textarea id="missionDesc" placeholder="Describe the impact..." class="input-box h-24"></textarea>
                    <input type="text" id="missionImage" placeholder="Cover Image URL" class="input-box">
                    <input type="number" id="missionGoal" placeholder="Seeding Goal ‚Çµ" class="input-box">
                    <button onclick="publishMission()" class="w-full py-4 bg-amber-600 text-white font-black rounded-2xl text-[10px] uppercase">Deploy to Hub</button>
                </div>
            </div>
        </section>

        <section id="messages" class="tab-content">
            <div id="inboxView">
                <h3 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest px-2 italic">Active Links</h3>
                <div id="contactList" class="space-y-2"></div>
            </div>

            <div id="chatView" class="view-hidden flex flex-col h-[65vh]">
                <div class="flex justify-between items-center mb-4 bg-white/5 p-4 rounded-2xl border border-white/5">
                    <button onclick="closeChat()" class="text-emerald-500 text-[10px] font-black uppercase">‚Üê Back</button>
                    <p id="activeChatName" class="text-[10px] font-black uppercase tracking-tighter text-white"></p>
                    <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                </div>
                <div id="adminChatBox" class="flex-1 overflow-y-auto no-scrollbar flex flex-col p-2"></div>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="adminReplyInput" placeholder="Secure Reply..." class="input-box flex-1">
                    <button onclick="sendAdminReply()" class="bg-emerald-500 text-black px-6 rounded-2xl font-black text-[10px] uppercase">Send</button>
                </div>
            </div>
        </section>

        <section id="harvest" class="tab-content">
            <div class="auth-card p-6 mb-6 border-emerald-500/20">
                <h3 class="text-sm font-black uppercase text-emerald-500 mb-4 italic">Release Grace</h3>
                <input type="number" id="hAmount" placeholder="Amount ‚Çµ" class="input-box mb-4">
                <button onclick="broadcastGrace()" class="w-full py-4 bg-emerald-600 text-white font-black rounded-2xl text-xs uppercase italic">Inject Liquidity</button>
            </div>
            <div class="auth-card p-6 border-rose-500/20">
                <h3 class="text-sm font-black uppercase text-rose-500 mb-4 italic">Execute Wither</h3>
                <input type="number" id="wAmount" placeholder="Amount ‚Çµ" class="input-box mb-4">
                <button onclick="broadcastWither()" class="w-full py-4 bg-rose-600 text-white font-black rounded-2xl text-xs uppercase italic">Engage Wither</button>
            </div>
        </section>

        <section id="payouts" class="tab-content">
            <h3 class="text-[10px] font-black text-slate-500 uppercase mb-4 px-2 italic">Withdrawal Queue (2% Service Charge)</h3>
            <div id="payoutList" class="space-y-3"></div>
        </section>

        <section id="ledger" class="tab-content">
            <div class="auth-card overflow-hidden">
                <div class="grid grid-cols-3 p-4 bg-white/5 text-[8px] font-black uppercase text-slate-400 italic">
                    <div>Node / Time</div>
                    <div>Protocol</div>
                    <div class="text-right">Value</div>
                </div>
                <div id="ledgerTable" class="max-h-[60vh] overflow-y-auto no-scrollbar"></div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-slate-950/90 border-t border-white/10 backdrop-blur-xl flex justify-around items-center z-50">
        <div class="nav-link active" onclick="openTab(event, 'nodes')"><span>üë•</span><p class="text-[7px] font-black uppercase mt-1">Nodes</p></div>
        <div class="nav-link" onclick="openTab(event, 'missions')"><span>üöÄ</span><p class="text-[7px] font-black uppercase mt-1">Impact</p></div>
        <div class="nav-link" onclick="openTab(event, 'messages')">
            <div id="navMsgBadge" class="nav-badge view-hidden">0</div>
            <span>üí¨</span><p class="text-[7px] font-black uppercase mt-1">Chat</p>
        </div>
        <div class="nav-link" onclick="openTab(event, 'harvest')"><span>üåø</span><p class="text-[7px] font-black uppercase mt-1">Harvest</p></div>
        <div class="nav-link" onclick="openTab(event, 'payouts')"><span>üí∞</span><p class="text-[7px] font-black uppercase mt-1">Payouts</p></div>
        <div class="nav-link" onclick="openTab(event, 'ledger')"><span>üìú</span><p class="text-[7px] font-black uppercase mt-1">Ledger</p></div>
    </nav>

    <script>
        const SB_URL = window.CONFIG?.SB_URL || "https://efiacszdzogknbucfgeu.supabase.co";
        const SB_KEY = window.CONFIG?.SB_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmaWFjc3pkem9na25idWNmZ2V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MjYyMDYsImV4cCI6MjA4NjQwMjIwNn0.F_fle-dOk-g1Pvh5ezDinOAzGWwlIBhLYvZkNAc2Ouc";
        const _gv = supabase.createClient(SB_URL, SB_KEY);
        let adminUser = null, allNodes = [], currentChatId = null, nodeStats = {};

        async function sync() {
            const { data: nodes } = await _gv.from('profiles').select('*');
            const { data: ledger } = await _gv.from('ledger').select('*').order('created_at', { ascending: false });
            const { data: msgs } = await _gv.from('messages').select('*').order('created_at', { ascending: false });
            const { data: missions } = await _gv.from('system_events').select('*').eq('type', 'mission');

            allNodes = nodes || [];
            let totalSeeded = 0, totalWithdrawn = 0, totalVaulted = 0;
            nodeStats = {};

            nodes?.forEach(n => nodeStats[n.id] = { seeded: 0, vaulted: 0, withdrawn: 0, name: n.full_name || n.email.split('@')[0] });

            ledger?.forEach(l => {
                const amt = Math.abs(l.amount);
                const isSeed = l.entry_type === 'seed';
                const isWithdraw = l.entry_type === 'withdrawal';
                const isVault = l.description.includes('Vault');

                if (isSeed && !isVault) totalSeeded += amt;
                if (isWithdraw) totalWithdrawn += amt;

                if (nodeStats[l.user_id]) {
                    if (isSeed && !isVault) nodeStats[l.user_id].seeded += amt;
                    if (isVault) nodeStats[l.user_id].vaulted += amt;
                    if (isWithdraw) nodeStats[l.user_id].withdrawn += amt;
                }
            });

            // Calculate current liquid pool and total vaulted across system
            document.getElementById('stat-pool').innerText = `‚Çµ${(totalSeeded - totalWithdrawn).toFixed(2)}`;
            document.getElementById('stat-seeded').innerText = `‚Çµ${totalSeeded.toFixed(2)}`;
            document.getElementById('stat-nodes').innerText = nodes?.length || 0;

            let systemVaulted = 0;
            nodes.forEach(n => { if(nodeStats[n.id]) systemVaulted += (nodeStats[n.id].vaulted - nodeStats[n.id].withdrawn); });
            document.getElementById('stat-vaulted').innerText = `‚Çµ${systemVaulted.toFixed(2)}`;

            renderNodes();
            renderMissions(missions);
            renderMessages(msgs);
            renderPayouts(ledger);
            renderLedger(ledger);
        }

        function renderNodes() {
            const term = document.getElementById('nodeSearch').value.toLowerCase();
            const filtered = allNodes.filter(n => n.email.toLowerCase().includes(term) || (n.full_name||'').toLowerCase().includes(term));
            
            document.getElementById('nodeList').innerHTML = filtered.map(n => {
                const stats = nodeStats[n.id] || {seeded:0, vaulted:0, withdrawn:0};
                const bal = (stats.vaulted - stats.withdrawn);
                return `
                <div class="auth-card p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-[11px] font-black uppercase text-white">${n.full_name || 'PENDING ID'}</p>
                            <p class="text-[7px] text-slate-500 font-bold tracking-widest">${n.email}</p>
                        </div>
                        <span class="status-pill ${n.is_gifter ? 'bg-emerald-500/20 text-emerald-500' : 'bg-rose-500/20 text-rose-500'}">
                            ${n.is_gifter ? 'Verified' : 'Locked'}
                        </span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-black/20 p-2 rounded-xl text-center">
                            <p class="text-[6px] uppercase text-slate-500 mb-1">Vault</p>
                            <p class="text-[9px] font-black text-emerald-400">‚Çµ${bal.toFixed(2)}</p>
                        </div>
                        <div class="bg-black/20 p-2 rounded-xl text-center">
                            <p class="text-[6px] uppercase text-slate-500 mb-1">Seeded</p>
                            <p class="text-[9px] font-black text-white">‚Çµ${stats.seeded.toFixed(0)}</p>
                        </div>
                        <div class="bg-black/20 p-2 rounded-xl text-center">
                            <p class="text-[6px] uppercase text-slate-500 mb-1">Limit</p>
                            <p class="text-[9px] font-black text-blue-400">‚Çµ${n.current_range_max || 0}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="quickAuth('${n.email}')" class="btn-action btn-verify flex-1">Authorize</button>
                        <button onclick="openChat('${n.id}')" class="btn-action btn-msg flex-1">Chat</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderMissions(missions) {
            document.getElementById('billboardContent').innerHTML = missions?.map(m => `
                <div class="billboard-card">
                    <img src="${m.image_url || 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853'}" class="billboard-img">
                    <div class="billboard-overlay">
                        <p class="text-[8px] font-black text-amber-500 uppercase tracking-[0.3em] mb-1">${m.category || 'IMPACT'}</p>
                        <h4 class="text-lg font-black italic text-white uppercase mb-2">${m.title}</h4>
                        <div class="flex justify-between items-center border-t border-white/20 pt-3">
                            <p class="text-[9px] font-black text-white/60">GOAL: ‚Çµ${m.value}</p>
                            <button onclick="deleteMission('${m.id}')" class="text-rose-500 text-[8px] font-black uppercase">End Mission</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderMessages(msgs) {
            const unread = msgs.filter(m => m.receiver_id === adminUser?.id && !m.is_read).length;
            const badge = document.getElementById('navMsgBadge');
            if(unread > 0) { badge.innerText = unread; badge.classList.remove('view-hidden'); } else { badge.classList.add('view-hidden'); }

            if(currentChatId) {
                const thread = msgs.filter(m => m.sender_id === currentChatId || m.receiver_id === currentChatId).reverse();
                document.getElementById('adminChatBox').innerHTML = thread.map(m => `
                    <div class="chat-bubble ${m.sender_id === adminUser.id ? 'bubble-out' : 'bubble-in'}">
                        ${m.content}
                    </div>
                `).join('');
                document.getElementById('adminChatBox').scrollTop = 9999;
                _gv.from('messages').update({ is_read: true }).eq('sender_id', currentChatId).eq('receiver_id', adminUser.id);
            } else {
                const uniqueSenders = [...new Set(msgs.map(m => m.sender_id))].filter(id => id !== adminUser?.id);
                document.getElementById('contactList').innerHTML = uniqueSenders.map(id => {
                    const lastMsg = msgs.find(m => m.sender_id === id || m.receiver_id === id);
                    const nodeName = nodeStats[id]?.name || "Anonymous Node";
                    return `
                    <div onclick="openChat('${id}')" class="auth-card p-4 flex justify-between items-center cursor-pointer mb-2">
                        <div>
                            <p class="text-[10px] font-black uppercase text-white">${nodeName}</p>
                            <p class="text-[8px] text-slate-500 line-clamp-1">${lastMsg?.content}</p>
                        </div>
                        <span class="text-emerald-500">‚Üí</span>
                    </div>`;
                }).join('');
            }
        }

        function renderPayouts(ledger) {
            const queue = ledger.filter(l => l.entry_type === 'withdrawal' && !l.description.includes('PAID'));
            document.getElementById('payoutList').innerHTML = queue.map(w => {
                const net = Math.abs(w.amount) * 0.98;
                const fee = Math.abs(w.amount) * 0.02;
                return `
                <div class="auth-card p-4 flex justify-between items-center border-l-4 border-amber-500">
                    <div>
                        <p class="text-[10px] font-black text-white uppercase">${nodeStats[w.user_id]?.name || 'Node'}</p>
                        <p class="text-[7px] text-slate-500">VAULT: ‚Çµ${Math.abs(w.amount)} | FEE: ‚Çµ${fee.toFixed(2)}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-black text-emerald-400 mb-2">‚Çµ${net.toFixed(2)}</p>
                        <button onclick="approvePayout('${w.id}', ${net})" class="text-[8px] bg-emerald-600 text-white px-3 py-1 rounded font-black uppercase">Confirm</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderLedger(ledger) {
            document.getElementById('ledgerTable').innerHTML = ledger.map(l => `
                <div class="ledger-row">
                    <div>
                        <p class="text-[9px] font-black text-white truncate">${nodeStats[l.user_id]?.name || 'SYSTEM'}</p>
                        <p class="text-[6px] text-slate-600 uppercase">${new Date(l.created_at).toLocaleTimeString()}</p>
                    </div>
                    <div class="text-[7px] font-black text-slate-400 uppercase text-center px-2">${l.description}</div>
                    <div class="text-right font-black text-[10px] ${l.amount > 0 ? 'text-emerald-500' : 'text-rose-500'}">
                        ‚Çµ${Math.abs(l.amount).toFixed(0)}
                    </div>
                </div>
            `).join('');
        }

        /* ACTIONS */
        async function updateNodeStatus() {
            const email = document.getElementById('targetEmail').value;
            const max = document.getElementById('maxRange').value || 500;
            const min = document.getElementById('minRange').value || 10;
            await _gv.from('profiles').update({ is_gifter: true, current_range_min: parseFloat(min), current_range_max: parseFloat(max) }).eq('email', email);
            sync();
        }

        async function quickAuth(email) {
            await _gv.from('profiles').update({ is_gifter: true, current_range_max: 500 }).eq('email', email);
            sync();
        }

        async function publishMission() {
            const title = document.getElementById('missionTitle').value;
            const desc = document.getElementById('missionDesc').value;
            const img = document.getElementById('missionImage').value;
            const goal = document.getElementById('missionGoal').value;
            await _gv.from('system_events').insert([{ type: 'mission', title, description: desc, image_url: img, value: parseFloat(goal) }]);
            sync();
        }

        async function broadcastGrace() {
            const amt = parseFloat(document.getElementById('hAmount').value);
            await _gv.from('system_events').insert([{ type: 'grace', value: amt }]);
            alert("Grace Distributed"); sync();
        }

        async function broadcastWither() {
            const amt = parseFloat(document.getElementById('wAmount').value);
            await _gv.from('system_events').insert([{ type: 'wither', value: amt }]);
            alert("Wither Engaged"); sync();
        }

        async function approvePayout(id, net) {
            await _gv.from('ledger').update({ description: `PAID ‚Çµ${net.toFixed(2)} (SENT)` }).eq('id', id);
            sync();
        }

        async function sendAdminReply() {
            const input = document.getElementById('adminReplyInput');
            if(!input.value || !currentChatId) return;
            await _gv.from('messages').insert([{ sender_id: adminUser.id, receiver_id: currentChatId, content: input.value, sender_name: 'ADMIN' }]);
            input.value = ''; sync();
        }

        function openChat(id) { 
            currentChatId = id; 
            document.getElementById('activeChatName').innerText = nodeStats[id]?.name || "Node";
            document.getElementById('inboxView').classList.add('view-hidden'); 
            document.getElementById('chatView').classList.remove('view-hidden'); 
            openTab(null, 'messages');
            sync();
        }

        function closeChat() { currentChatId = null; document.getElementById('chatView').classList.add('view-hidden'); document.getElementById('inboxView').classList.remove('view-hidden'); }

        function openTab(e, n) { 
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
            document.getElementById(n).classList.add('active'); 
            if(e) e.currentTarget.classList.add('active');
            else document.querySelector(`[onclick*="${n}"]`).classList.add('active');
            if(n !== 'messages') closeChat();
        }

        async function init() {
            const { data: { user } } = await _gv.auth.getUser();
            if(!user) return;
            adminUser = user;
            sync();
            _gv.channel('realtime').on('postgres_changes', { event: '*', schema: 'public' }, () => sync()).subscribe();
        }
        init();
    </script>
</body>
</html>
